import React, { useState, useEffect, useCallback } from 'react';
import { Button } from "/components/ui/button";
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "/components/ui/card";

const TicTacToeGame = () => {
  const [board, setBoard] = useState<(string | null)[]>(Array(9).fill(null));
  const [isXNext, setIsXNext] = useState<boolean>(true);
  const [winner, setWinner] = useState<string | null>(null);
  const [isDraw, setIsDraw] = useState<boolean>(false);
  const [isMobile, setIsMobile] = useState<boolean>(false);
  const [showTouchControls, setShowTouchControls] = useState<boolean>(false);

  // Check if device is mobile
  useEffect(() => {
    const checkIsMobile = () => {
      const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isSmallScreen = window.innerWidth < 768;
      setIsMobile(hasTouch || isSmallScreen);
      setShowTouchControls(hasTouch || isSmallScreen);
    };

    checkIsMobile();
    window.addEventListener('resize', checkIsMobile);
    
    return () => window.removeEventListener('resize', checkIsMobile);
  }, []);

  // Keyboard controls for desktop
  useEffect(() => {
    if (!isMobile && !winner && !isDraw) {
      const handleKeyPress = (e: KeyboardEvent) => {
        const key = e.key;
        if (key >= '1' && key <= '9') {
          const position = parseInt(key) - 1;
          if (board[position] === null) {
            handleMove(position);
          }
        } else if (key === 'r' || key === 'R') {
          resetGame();
        }
      };

      window.addEventListener('keydown', handleKeyPress);
      return () => window.removeEventListener('keydown', handleKeyPress);
    }
  }, [board, isMobile, winner, isDraw]);

  // Check for winner
  const calculateWinner = useCallback((squares: (string | null)[]) => {
    const lines = [
      [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
      [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
      [0, 4, 8], [2, 4, 6]             // diagonals
    ];

    for (const [a, b, c] of lines) {
      if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
        return squares[a];
      }
    }

    return null;
  }, []);

  // Check for draw
  const checkDraw = useCallback((squares: (string | null)[]) => {
    return squares.every(square => square !== null) && !calculateWinner(squares);
  }, [calculateWinner]);

  // Handle square click
  const handleMove = (position: number) => {
    if (winner || isDraw || board[position]) return;

    const newBoard = [...board];
    newBoard[position] = isXNext ? 'X' : 'O';
    
    setBoard(newBoard);
    setIsXNext(!isXNext);
    
    const newWinner = calculateWinner(newBoard);
    if (newWinner) {
      setWinner(newWinner);
    } else if (checkDraw(newBoard)) {
      setIsDraw(true);
    }
  };

  // Reset game
  const resetGame = () => {
    setBoard(Array(9).fill(null));
    setIsXNext(true);
    setWinner(null);
    setIsDraw(false);
  };

  // Render individual square
  const renderSquare = (position: number) => {
    return (
      <button
        onClick={() => handleMove(position)}
        disabled={!!winner || !!board[position] || isDraw}
        className={`w-16 h-16 md:w-20 md:h-20 flex items-center justify-center text-3xl md:text-4xl font-bold 
                  border-2 border-gray-300 rounded-lg transition-all duration-200
                  ${!board[position] && !winner && !isDraw ? 'hover:bg-gray-100 active:bg-gray-200' : ''}
                  ${board[position] === 'X' ? 'text-blue-600' : ''}
                  ${board[position] === 'O' ? 'text-red-600' : ''}
                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50`}
        aria-label={`Square ${position + 1}${board[position] ? ` with ${board[position]}` : ''}`}
      >
        {board[position]}
      </button>
    );
  };

  // Get game status text
  const getStatus = () => {
    if (winner) {
      return `Winner: ${winner}`;
    } else if (isDraw) {
      return "It's a draw!";
    } else {
      return `Next player: ${isXNext ? 'X' : 'O'}`;
    }
  };

  // Virtual keyboard for mobile
  const renderVirtualKeyboard = () => {
    if (!showTouchControls || winner || isDraw) return null;

    return (
      <div className="mt-6 p-4 bg-gray-100 rounded-lg">
        <h3 className="text-sm font-medium text-gray-700 mb-2">Tap to move:</h3>
        <div className="grid grid-cols-3 gap-2">
          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
            <Button
              key={num}
              onClick={() => handleMove(num - 1)}
              disabled={!!board[num - 1]}
              variant="outline"
              className="h-12 text-lg font-mono"
            >
              {num}
            </Button>
          ))}
        </div>
      </div>
    );
  };

  // Keyboard instructions for desktop
  const renderKeyboardInstructions = () => {
    if (isMobile || winner || isDraw) return null;

    return (
      <div className="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
        <p>Keyboard controls: Press 1-9 to place your move, R to reset</p>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8 px-4 flex flex-col items-center justify-center">
      <Card className="w-full max-w-md shadow-lg">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl md:text-3xl font-bold text-gray-800">Tic Tac Toe</CardTitle>
          <CardDescription className="text-gray-600">
            A classic game of X and O
          </CardDescription>
        </CardHeader>
        
        <CardContent className="flex flex-col items-center">
          {/* Game status */}
          <div className={`text-lg font-semibold mb-6 px-4 py-2 rounded-lg 
                          ${winner ? 'bg-green-100 text-green-800' : 
                            isDraw ? 'bg-yellow-100 text-yellow-800' : 
                            'bg-gray-100 text-gray-800'}`}>
            {getStatus()}
          </div>

          {/* Game board */}
          <div className="grid grid-cols-3 gap-2 md:gap-3 bg-white p-4 rounded-xl shadow-md">
            {[0, 1, 2, 3, 4, 5, 6, 7, 8].map(position => (
              <div key={position}>
                {renderSquare(position)}
              </div>
            ))}
          </div>

          {/* Controls instructions */}
          {renderVirtualKeyboard()}
          {renderKeyboardInstructions()}
        </CardContent>

        <CardFooter className="flex justify-center">
          <Button 
            onClick={resetGame} 
            variant="default" 
            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2"
          >
            Reset Game
          </Button>
        </CardFooter>
      </Card>
    </div>
  );
};


